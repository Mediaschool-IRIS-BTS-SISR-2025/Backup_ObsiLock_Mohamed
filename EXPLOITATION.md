# Guide d'Exploitation - ObsiLock API

## üîÑ Gestion des services Docker

### D√©marrer les services
```bash
cd /home/iris/slam/ObsiLock
docker compose up -d
```

**R√©sultat attendu :**
```
[+] Running 3/3
 ‚úî Container obsilock_db           Started
 ‚úî Container obsilock_phpmyadmin   Started
 ‚úî Container obsilock_api          Started
```

### Arr√™ter les services
```bash
docker compose down
```

### Red√©marrer un service sp√©cifique
```bash
# API uniquement (apr√®s modification code)
docker compose restart api

# Base de donn√©es
docker compose restart db

# Tous les services
docker compose restart
```

### Voir l'√©tat des services
```bash
# Liste des conteneurs
docker ps

# Utilisation CPU/RAM en temps r√©el
docker stats

# Logs en direct
docker compose logs -f

# Logs d'un service sp√©cifique
docker compose logs -f api
docker compose logs -f db
```

---

## üíæ Sauvegardes automatiques

### Sauvegarde compl√®te manuelle

```bash
cd /home/iris/slam/ObsiLock
./backup.sh
```

**Ce qui est sauvegard√© :**
1. **Base de donn√©es** : Dump SQL complet (structure + donn√©es)
2. **Fichiers chiffr√©s** : Contenu de `storage/uploads/`
3. **Configuration** : `.env`, `docker-compose.yml`, `composer.json/lock`
4. **Code source** : Dossiers `src/`, `migrations/`, `public/`

**Emplacement des sauvegardes :**
```
/home/mohamed/backup/slam/obsilock/
‚îú‚îÄ‚îÄ obsilock_backup_20251230_153045.tar.gz
‚îú‚îÄ‚îÄ backup_20251230_153045.log
‚îî‚îÄ‚îÄ ...
```

**R√©tention :** 7 jours (modifiable dans `backup.sh`)

### Restauration d'une sauvegarde

```bash
./restore.sh
```

**Proc√©dure :**
1. Le script affiche la liste des backups disponibles
2. S√©lectionner le num√©ro du backup
3. Taper "OUI" (en majuscules) pour confirmer
4. Attendre la restauration (~30 secondes)
5. V√©rifier que les services ont red√©marr√©

**‚ö†Ô∏è ATTENTION :** La restauration √©crase toutes les donn√©es actuelles !

### Automatisation avec Cron

**Backup quotidien √† 3h00 du matin :**
```bash
crontab -e

# Ajouter cette ligne :
0 3 * * * cd /home/iris/slam/ObsiLock && /bin/bash backup.sh >> /home/mohamed/backup/slam/obsilock/cron.log 2>&1
```

**Autres exemples :**
```bash
# Toutes les 6 heures
0 */6 * * * cd /home/iris/slam/ObsiLock && /bin/bash backup.sh

# Tous les dimanches √† minuit
0 0 * * 0 cd /home/iris/slam/ObsiLock && /bin/bash backup.sh

# Tous les jours √† 2h30
30 2 * * * cd /home/iris/slam/ObsiLock && /bin/bash backup.sh
```

**V√©rifier les t√¢ches Cron :**
```bash
crontab -l
```

**Voir les logs Cron :**
```bash
tail -f /home/mohamed/backup/slam/obsilock/cron.log
```

---

## üóÑÔ∏è Gestion de la base de donn√©es

### Acc√©der √† phpMyAdmin
```
URL : http://localhost:8081
Serveur : mysql
Utilisateur : obsilock_user
Mot de passe : (voir fichier .env)
```

### Connexion MySQL en ligne de commande
```bash
# Avec l'utilisateur applicatif
docker exec -it obsilock_db mysql -u obsilock_user -p coffre_fort

# Avec root
DB_ROOT_PASS=$(docker exec obsilock_db printenv MYSQL_ROOT_PASSWORD)
docker exec -it obsilock_db mysql -u root -p"${DB_ROOT_PASS}" coffre_fort
```

### Requ√™tes SQL utiles

**Statistiques globales :**
```sql
-- Nombre d'utilisateurs
SELECT COUNT(*) as total_users FROM users;

-- Espace total utilis√©
SELECT SUM(quota_used) / 1073741824 as total_gb FROM users;

-- Nombre de fichiers par utilisateur
SELECT u.email, COUNT(f.id) as nb_files, SUM(f.size) / 1048576 as size_mb
FROM users u
LEFT JOIN files f ON u.id = f.user_id
GROUP BY u.id;

-- Partages actifs
SELECT COUNT(*) as active_shares 
FROM shares 
WHERE is_revoked = 0 
  AND (expires_at IS NULL OR expires_at > NOW())
  AND (remaining_uses IS NULL OR remaining_uses > 0);
```

**Gestion des quotas :**
```sql
-- Utilisateurs proches de la limite (>80%)
SELECT 
    email,
    quota_used / 1048576 as used_mb,
    quota_total / 1048576 as total_mb,
    ROUND((quota_used / quota_total) * 100, 2) as percent_used
FROM users
WHERE (quota_used / quota_total) > 0.8
ORDER BY percent_used DESC;

-- Augmenter le quota d'un utilisateur (2 GB)
UPDATE users SET quota_total = 2147483648 WHERE email = 'user@example.com';
```

**Nettoyage :**
```sql
-- Supprimer les partages expir√©s depuis +30 jours
DELETE FROM shares 
WHERE expires_at < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- Supprimer les logs de t√©l√©chargement de +6 mois
DELETE FROM downloads_log 
WHERE downloaded_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- Supprimer les logs d'upload de +1 an
DELETE FROM upload_logs 
WHERE uploaded_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

### Export manuel de la base

```bash
# Export complet
DB_ROOT_PASS=$(docker exec obsilock_db printenv MYSQL_ROOT_PASSWORD)
docker exec obsilock_db mysqldump -u root -p"${DB_ROOT_PASS}" coffre_fort > backup_manual_$(date +%Y%m%d).sql

# Export structure uniquement (sans donn√©es)
docker exec obsilock_db mysqldump -u root -p"${DB_ROOT_PASS}" --no-data coffre_fort > structure.sql

# Export donn√©es uniquement
docker exec obsilock_db mysqldump -u root -p"${DB_ROOT_PASS}" --no-create-info coffre_fort > data.sql
```

---

## üìä Monitoring et statistiques

### √âtat des conteneurs
```bash
# Informations d√©taill√©es
docker inspect obsilock_api
docker inspect obsilock_db

# Ressources utilis√©es
docker stats --no-stream

# Historique de red√©marrages
docker ps -a | grep obsilock
```

### Espace disque

**Espace total du serveur :**
```bash
df -h
```

**Taille des fichiers upload√©s :**
```bash
du -sh storage/uploads/
du -sh storage/uploads/* | sort -h
```

**Taille des backups :**
```bash
du -sh /home/mohamed/backup/slam/obsilock/
ls -lh /home/mohamed/backup/slam/obsilock/*.tar.gz
```

**Taille de la base de donn√©es :**
```sql
SELECT 
    table_schema AS 'Database',
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)'
FROM information_schema.tables
WHERE table_schema = 'coffre_fort'
GROUP BY table_schema;
```

### Logs d'erreurs

**Logs API :**
```bash
# Toutes les erreurs
docker compose logs api | grep -i error

# Erreurs des derni√®res 24h
docker compose logs --since 24h api | grep -i error

# Erreurs 500
docker compose logs api | grep "500"
```

**Logs MySQL :**
```bash
docker compose logs db | grep -i error
docker compose logs db | grep -i warning
```

**Logs syst√®me (rate limiting, etc.) :**
```bash
# Voir les tentatives de d√©passement de rate limit
docker exec obsilock_api ls -la /tmp/obsilock_rate_limit/
```

---

## üîê S√©curit√© et maintenance

### Rotation des secrets

**1. G√©n√©rer de nouveaux secrets :**
```bash
# Nouveau JWT secret
openssl rand -base64 32

# Nouvelle cl√© de chiffrement
docker run --rm php:8.2-cli php -r "echo base64_encode(random_bytes(32)) . PHP_EOL;"
```

**2. Mettre √† jour `.env` :**
```bash
nano .env
# Remplacer JWT_SECRET et/ou ENCRYPTION_KEY
```

**3. Red√©marrer l'API :**
```bash
docker compose restart api
```

**‚ö†Ô∏è ATTENTION :**
- Changer `ENCRYPTION_KEY` rend les anciens fichiers illisibles !
- Changer `JWT_SECRET` invalide tous les tokens JWT existants

### V√©rifier les permissions

```bash
# Dossier uploads
ls -la storage/uploads/

# Fichier .env (doit √™tre 600)
ls -la .env

# Scripts
ls -la backup.sh restore.sh
```

### Mise √† jour de l'application

```bash
# 1. Sauvegarder d'abord
./backup.sh

# 2. Arr√™ter les services
docker compose down

# 3. Mettre √† jour le code
git pull origin main

# 4. Mettre √† jour les d√©pendances
docker run --rm -v $(pwd):/app composer install

# 5. Ex√©cuter les nouvelles migrations (si existantes)
DB_ROOT_PASS=$(docker exec obsilock_db printenv MYSQL_ROOT_PASSWORD)
for file in migrations/*.sql; do
    docker exec -i obsilock_db mysql -u root -p"${DB_ROOT_PASS}" coffre_fort < "$file"
done

# 6. Red√©marrer
docker compose up -d

# 7. V√©rifier
curl http://localhost:8080/
```

---

## üßπ Nettoyage et optimisation

### Nettoyer Docker

```bash
# Supprimer images inutilis√©es
docker image prune -a

# Supprimer volumes inutilis√©s
docker volume prune

# Nettoyage complet
docker system prune -a --volumes
```

### Optimiser la base de donn√©es

```bash
DB_ROOT_PASS=$(docker exec obsilock_db printenv MYSQL_ROOT_PASSWORD)

# Optimiser toutes les tables
docker exec -i obsilock_db mysql -u root -p"${DB_ROOT_PASS}" coffre_fort -e "
OPTIMIZE TABLE users;
OPTIMIZE TABLE files;
OPTIMIZE TABLE file_versions;
OPTIMIZE TABLE shares;
OPTIMIZE TABLE downloads_log;
OPTIMIZE TABLE upload_logs;
"
```

### Rotation des logs

```bash
# Nettoyer les anciens logs Docker
docker system events --since 24h | wc -l

# Configurer logrotate (optionnel)
sudo nano /etc/logrotate.d/obsilock
```

---

## üÜò Commandes d'urgence

### Red√©marrage complet en cas de probl√®me
```bash
cd /home/iris/slam/ObsiLock
docker compose down
sleep 5
docker compose up -d
docker compose logs -f
```

### Reset complet (‚ö†Ô∏è PERTE DE DONN√âES)
```bash
# 1. Sauvegarder d'abord
./backup.sh

# 2. Tout supprimer
docker compose down -v
rm -rf storage/uploads/*

# 3. R√©installer
docker compose up -d

# 4. R√©ex√©cuter les migrations
DB_ROOT_PASS=$(docker exec obsilock_db printenv MYSQL_ROOT_PASSWORD)
for file in migrations/*.sql; do
    docker exec -i obsilock_db mysql -u root -p"${DB_ROOT_PASS}" coffre_fort < "$file"
done
```

### Restaurer depuis un backup
```bash
./restore.sh
# S√©lectionner le backup le plus r√©cent
# Taper "OUI"
```

---

## üìû Support

**Documentation :**
- Installation : `docs/INSTALLATION.md`
- D√©pannage : `docs/TROUBLESHOOTING.md`
- API : `openapi.yaml` (Swagger)

**Logs importants :**
- Backup : `/home/mohamed/backup/slam/obsilock/*.log`
- Cron : `/home/mohamed/backup/slam/obsilock/cron.log`
- Docker : `docker compose logs`

**Commandes de diagnostic :**
```bash
# √âtat g√©n√©ral
docker ps
docker stats --no-stream
df -h

# Connexion BDD
docker exec -it obsilock_db mysql -u obsilock_user -p coffre_fort

# Tester l'API
curl http://localhost:8080/
```
